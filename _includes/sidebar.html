{% assign pages = site.pages | where_exp: "page", "page.path contains 'docs/'" %}

{% assign tree = {} %}
{% for page in pages %}
  {% assign segments = page.path | split: '/' %}
  {% assign last = segments | last %}

  {% capture current_path %}{{ segments | join: '/' }}{% endcapture %}
  {% assign parent = tree %}
  {% for i in (1..segments.size-2) %}
    {% capture folder %}{{ segments[i] }}{% endcapture %}
    {% if parent[folder] == nil %}
      {% assign parent = parent | merge: { folder: {} } %}
    {% endif %}
    {% assign parent = parent[folder] %}
  {% endfor %}
{% endfor %}

{% assign sorted_pages = pages | sort: "path" %}

{% capture render_tree %}
  <ul class="sidebar-root">
    {% for page in sorted_pages %}
      {% assign path_parts = page.path | split: '/' %}
      {% assign section = path_parts[1] %}
      {% assign subsection = path_parts[2] %}
      {% assign display_name = page.title | default: path_parts | last | replace: '.md', '' | replace: '.html', '' %}
      
      {% if path_parts.size == 3 %}
        <details class="sidebar-section" {% if page.url == page.url %}open{% endif %}>
          <summary>{{ section | replace: "-", " " | capitalize }}</summary>
          <ul class="sidebar-links">
            <li><a href="{{ page.url }}" class="{% if page.url == page.url %}active{% endif %}">{{ display_name }}</a></li>
          </ul>
        </details>
      {% elsif path_parts.size == 4 %}
        {% unless previous_section == section %}
          {% if previous_section %}
            </ul></details>
          {% endif %}
          <details class="sidebar-section" open>
            <summary>{{ section | replace: "-", " " | capitalize }}</summary>
            <ul class="sidebar-links">
        {% endunless %}
        <li style="padding-left: 16px;"><a href="{{ page.url }}" class="{% if page.url == page.url %}active{% endif %}">{{ display_name }}</a></li>
        {% assign previous_section = section %}
      {% endif %}
    {% endfor %}
  </ul>
{% endcapture %}
{{ render_tree }}
