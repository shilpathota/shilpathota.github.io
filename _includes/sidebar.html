<nav class="sidebar-nav">
  <div class="sidebar-title">ğŸ“š Knowledge Repository</div>

  {% assign pages = site.pages | where_exp: "p", "p.path contains 'docs/'" %}
  {% assign sorted_pages = pages | sort: "path" %}

  {% assign current_folder = nil %}
  {% assign current_subfolder = nil %}
  {% assign current_url = page.url %}

  {% for page in sorted_pages %}
    {% assign parts = page.path | remove: 'docs/' | split: '/' %}
    {% assign depth = parts.size %}
    {% assign filename = parts | last %}
    {% assign title = page.title | default: filename | replace: '.md', '' | replace: '.html', '' | replace: '%20', ' ' %}

    {% if depth == 2 %}
      {% assign folder = parts[0] %}
      {% if folder != current_folder %}
        {% if current_subfolder %}</ul></details>{% assign current_subfolder = nil %}{% endif %}
        {% if current_folder %}</ul></details>{% endif %}
        <details class="sidebar-section" {% if current_url contains folder %}open{% endif %}>
          <summary>{{ folder | upcase }}</summary>
          <ul class="sidebar-links">
        {% assign current_folder = folder %}
      {% endif %}
      <li><a href="{{ page.url }}" class="{% if current_url == page.url %}active{% endif %}">{{ title }}</a></li>
    {% elsif depth == 3 %}
      {% assign folder = parts[0] %}
      {% assign subfolder = parts[1] %}
      {% if subfolder != current_subfolder %}
        {% if current_subfolder %}</ul></details>{% endif %}
        <details class="sidebar-subsection" {% if current_url contains subfolder %}open{% endif %}>
          <summary>{{ subfolder | capitalize }}</summary>
          <ul class="sidebar-links">
        {% assign current_subfolder = subfolder %}
      {% endif %}
      <li><a href="{{ page.url }}" class="{% if current_url == page.url %}active{% endif %}">{{ title }}</a></li>
    {% endif %}
  {% endfor %}

  {% if current_subfolder %}</ul></details>{% endif %}
  {% if current_folder %}</ul></details>{% endif %}
</nav>
