<nav class="sidebar-nav">
  <div class="sidebar-title">ðŸ“š Knowledge Repository</div>

  {% assign pages = site.pages | where_exp: "p", "p.path contains 'docs/'" %}
  {% assign sorted_pages = pages | sort: "path" %}

  {% assign tree = {} %}
  {% assign current_url = page.url %}

  {% for page in sorted_pages %}
    {% assign parts = page.path | remove: 'docs/' | split: '/' %}
    {% assign depth = parts.size %}
    {% assign filename = parts | last %}

    {% if filename contains '.md' or filename contains '.html' %}
      {% assign file_display = page.title | default: filename | replace: '.md', '' | replace: '.html', '' | replace: '%20', ' ' %}
      
      {% if depth == 1 %}
        <details class="sidebar-section" {% if current_url contains parts[0] %}open{% endif %}>
          <summary>{{ parts[0] | capitalize }}</summary>
          <ul class="sidebar-links">
            <li><a href="{{ page.url }}" class="{% if current_url == page.url %}active{% endif %}">{{ file_display }}</a></li>
          </ul>
        </details>
      {% elsif depth == 2 %}
        {% assign folder = parts[0] %}
        {% if folder != previous_folder %}
          {% if previous_folder %}</ul></details>{% endif %}
          <details class="sidebar-section" {% if current_url contains folder %}open{% endif %}>
            <summary>{{ folder | capitalize }}</summary>
            <ul class="sidebar-links">
          {% assign previous_folder = folder %}
        {% endif %}
        <li><a href="{{ page.url }}" class="{% if current_url == page.url %}active{% endif %}">{{ file_display }}</a></li>
      {% elsif depth == 3 %}
        {% assign folder = parts[0] %}
        {% assign subfolder = parts[1] %}
        {% assign folder_key = folder | append: '-' | append: subfolder %}
        {% if folder_key != previous_subfolder %}
          {% if previous_subfolder %}</ul></details>{% endif %}
          <details class="sidebar-subsection" {% if current_url contains subfolder %}open{% endif %}>
            <summary>{{ subfolder | capitalize }}</summary>
            <ul class="sidebar-links">
          {% assign previous_subfolder = folder_key %}
        {% endif %}
        <li><a href="{{ page.url }}" class="{% if current_url == page.url %}active{% endif %}">{{ file_display }}</a></li>
      {% endif %}
    {% endif %}
  {% endfor %}

  {% if previous_subfolder %}</ul></details>{% endif %}
  {% if previous_folder %}</ul></details>{% endif %}
</nav>
